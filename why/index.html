<html>
  <head>
    <title>why watch worms?</title>
    <script src="oppressive.js"></script>
  </head>
  <body>
    <script>
var Recording = function(id, spec) {
    OP.Objection.call(this, id, spec);
};
Recording.prototype = new OP.Objection;
Recording.prototype.render = function(mode,type) {
    var $d = document.createElement(type||'img');
    $d.src = "data/" + this.filename + mode;
    return $d;
};

var CONTOUR_MODES = ["ADP45", "MOT60", "MBL50", "MBL75"];

var STILL_MODES = {"First frame": ".first.png",
                   "Composite frame": ".comp.png"}
var VIDEO_MODES = {"Video": ".webm"}

CONTOUR_MODES.forEach(function(mode) {
    STILL_MODES[mode+" threshold"] = ".contours"+mode+".png";
    STILL_MODES[mode+" path"] = ".path"+mode+".png";
    VIDEO_MODES[mode+" threshold"] = ".contours"+mode+".webm";
    VIDEO_MODES[mode+" path"] = ".showmotion"+mode+".webm";
});

var dataTable = function(recs) {
    var DATA_POINTS = ["speed", "motion", "distance", "radius", "area", "raw_motion", "nworms"];
    var $el = document.createElement('table');
    $el.setAttribute('border', 1);

    // heading
    var $tr = document.createElement('tr');
    $el.appendChild($tr);
    var $th = document.createElement('th');
    $tr.appendChild($th);
    $th.innerHTML = "recording";
    CONTOUR_MODES.forEach(function(cmode) {
        DATA_POINTS.forEach(function(dpoint) {
            var $th = document.createElement('th');
            $tr.appendChild($th);
            $th.innerHTML = dpoint + " (" + cmode + ")";
        });
    });

    // body
    recs.forEach(function(rec) {
        var $tr = document.createElement('tr');
        $el.appendChild($tr);
        var $td = document.createElement('td');
        $tr.appendChild($td);
        $td.innerHTML = rec.filename;
        CONTOUR_MODES.forEach(function(cmode) {
            DATA_POINTS.forEach(function(dpoint) {
                var $td = document.createElement('td');
                $tr.appendChild($td);
                $td.innerHTML = rec[dpoint + "_" + cmode];
            });
        });
    });
    
    return $el;
};


var MultiRec = function(recs) {
    this.recs = recs;
    this.$el = document.createElement('div');
    this.$all = document.createElement('div');
    $sel = document.createElement('select');
    $vsel = document.createElement('select');

    var modes = [];
    for(var key in STILL_MODES) {
        var $opt = document.createElement('option');
        $opt.innerHTML = key;
        $sel.appendChild($opt);
        modes.push(key);
    };
    var that = this;
    $sel.onchange = function(ev) {
        that.render(STILL_MODES[modes[$sel.selectedIndex]]);
    }

    var vmodes = [];
    for(var key in VIDEO_MODES) {
        var $opt = document.createElement('option');
        $opt.innerHTML = key;
        $vsel.appendChild($opt);
        vmodes.push(key);
    };
    $vsel.onchange = function(ev) {
        that.render(VIDEO_MODES[vmodes[$vsel.selectedIndex]], 'video');
    }

    this.$el.appendChild($sel);
    this.$el.appendChild($vsel);
    this.$el.appendChild(this.$all);
    this.render(STILL_MODES['First frame']);
};
MultiRec.prototype.render = function(mode,type) {
    var $a = this.$all;
    $a.innerHTML = "";
    this.recs.forEach(function(r) {
        $a.appendChild(r.render(mode,type));
    });
};

var MR = null;

OP.Subjectification.load(
    {'Recording.json': Recording}, function() {

    MR = new MultiRec(OP.Subjectification.all(Recording));
    document.body.appendChild(dataTable(OP.Subjectification.all(Recording)));
    document.body.appendChild(MR.$el);

});

    </script>
  </body>
</html>
